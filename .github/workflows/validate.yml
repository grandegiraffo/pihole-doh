name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  validate:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Trim DNS port lines from docker-compose.yml
        run: sed -i.bak -e '/53:53/d' docker-compose.yml

      - name: Validate docker-compose.yml
        run: docker compose config

      - name: Start up containers
        run: docker compose up --detach --wait

      - name: Wait for services to be healthy
        run: |
          echo "Waiting for Cloudflared to be healthy..."
          timeout 60 sh -c 'until docker compose ps cloudflared | grep -q "healthy"; do sleep 2; done' || true
          echo "Waiting for Pi-hole to be healthy..."
          timeout 120 sh -c 'until docker compose ps pihole | grep -q "healthy"; do sleep 2; done' || true

      - name: Test Cloudflared container
        run: |
          curl -sf --retry 5 --retry-delay 5 --retry-max-time 60 http://172.20.0.3:49312/metrics || \
          (docker compose logs cloudflared && exit 1)

      - name: Test Pi-hole container
        run: |
          curl -sf --retry 5 --retry-delay 5 --retry-max-time 60 http://172.20.0.2/admin || \
          (docker compose logs pihole && exit 1)

      - name: Stop and remove containers
        if: always()
        run: docker compose down -v
